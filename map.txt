import { useParams } from "react-router-dom";
import {
  Button,
  Card,
  CardBody,
  CardHeader,
  CardTitle,
  Col,
  FormGroup,
  Input,
  InputGroup,
  InputGroupText,
  Label,
  Nav,
  NavItem,
  NavLink,
  PopoverBody,
  PopoverHeader,
  Row,
  Spinner,
  TabContent,
  TabPane,
  UncontrolledPopover,
} from "reactstrap";
import { getAirscanTestPageAccess } from "./iaqSlice";
import type {
  AirscanTestPageAccess,
  EquipmentTemplate,
  UploadedAirscan,
} from "@mach-energy/common-backend/src/types";
import { useEffect, useRef, useState } from "react";
import { useAppDispatch, useAppSelector } from "@src/redux/hooks";
import Select, { SingleValue } from "react-select";
import { Download, Info, X } from "react-feather";
import { utils, read } from "xlsx";
import AirscanTestingTablePublic from "./AirscanTestingTablePublic";
import {
  checkUploadedAirscansList,
  generateManufacturerReport,
  orphanUploadedAirscans,
  registerUploadedAirscans,
  removeAirscanFromTesting,
} from "./airscanRegistrationSlice";
import ConfirmModal from "@mycomponents/common/ConfirmModal";
import DownloadFile from "@mycomponents/common/DownloadFile";
import toast from "react-hot-toast";

type EquipmentTemplateOption = SingleValue<{
  label: string;
  value: EquipmentTemplate;
}>;

type ExcelRow = {
  "Device ID": string;
  "Reference Device ID"?: string;
  "Equipment Type": string;
};

const REFRESH_SECONDS = 30;

const AirscanTestingPagePublic = () => {
  const { uuid } = useParams();

  const inputRef = useRef<HTMLInputElement>(null);
  const dispatch = useAppDispatch();
  const { checkedAirscanUpload, modalMessage } = useAppSelector(
    ({ airscanRegistration }) => airscanRegistration,
  );

  const [afterCheckMessage, setAfterCheckMessage] = useState<
    string | undefined
  >();
  useEffect(() => {
    if (modalMessage) {
      setAfterCheckMessage(modalMessage);
    }
  }, [modalMessage]);
  const [loading, setLoading] = useState(false);
  const [deviceId, setDeviceId] = useState("");
  const [referenceDeviceId, setReferenceDeviceId] = useState("");
  const [activeTab, setActiveTab] = useState("non-calibration");
  const [uploadedAirscans, setUploadedAirscans] = useState<UploadedAirscan[]>(
    [],
  );
  const [equipmentTemplateOption, setEquipmentTemplateOption] =
    useState<EquipmentTemplateOption>(null);
  const equipmentTemplate = equipmentTemplateOption?.value;
  const { templateSensors = [] } = equipmentTemplate ?? {};
  const showTemplateSensors = templateSensors.length > 0;
  const [airscanPageInfo, setAirscanPageInfo] = useState<
    | { access: AirscanTestPageAccess; equipmentTemplates: EquipmentTemplate[] }
    | undefined
  >();

  useEffect(() => {
    const checkAccess = async () => {
      setLoading(true);
      const {
        response: { result },
      } = await dispatch(getAirscanTestPageAccess({ uuid })).unwrap();
      setAirscanPageInfo(result);
      setLoading(false);
    };
    checkAccess();
  }, []);

  const [lastListToUpload, setLastListToUpload] = useState<
    UploadedAirscan[] | undefined
  >();
  useEffect(() => {
    const interval = setInterval(() => {
      if (lastListToUpload) {
        const promise = dispatch(
          checkUploadedAirscansList({
            uploadedAirscans: lastListToUpload,
            forRefresh: true,
          }),
        ).unwrap();
        toast.promise(promise, {
          loading: "Refreshing...",
          success: "Refreshed",
          error: "Couldn't refresh data",
        });
      }
    }, 1000 * REFRESH_SECONDS);
    return () => clearInterval(interval);
  }, [lastListToUpload]);

  if (loading) {
    return <Spinner />;
  }

  const access = airscanPageInfo?.access;
  const equipmentTemplates = airscanPageInfo?.equipmentTemplates;
  if (!access?.active) {
    return "Unavailable";
  }

  const description = access.description;

  const onExcelUpload = (e: any) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      if (e?.target?.result) {
        const data = new Uint8Array(e.target.result as any);
        const workbook = read(data, { type: "array" });
        const worksheet = workbook.Sheets["Template"];

        const json = utils.sheet_to_json(worksheet) as ExcelRow[];
        setUploadedAirscans(
          json.map(
            (row): UploadedAirscan => {
              const baseData = {
                deviceId: row["Device ID"],
                equipmentTemplateName: row["Equipment Type"],
              };
              
              // Add reference device ID if in re-calibration tab and the field exists
              if (activeTab === "re-calibration" && row["Reference Device ID"]) {
                return {
                  ...baseData,
                  referenceDeviceId: row["Reference Device ID"],
                } as UploadedAirscan & { referenceDeviceId: string };
              }
              
              return baseData;
            },
          ),
        );
      }
    };
    reader.readAsArrayBuffer(e.target.files![0]);
  };

  const onClearInput = () => {
    if (inputRef.current) {
      inputRef.current.value = "";
      setUploadedAirscans([]);
    }
  };

  const handleTabChange = (tab: string) => {
    setActiveTab(tab);
    // Clear form data when switching tabs
    setDeviceId("");
    setReferenceDeviceId("");
    setEquipmentTemplateOption(null);
    setUploadedAirscans([]);
    if (inputRef.current) {
      inputRef.current.value = "";
    }
  };

  const isDoingSingleUpload = activeTab === "non-calibration"
    ? deviceId !== "" || equipmentTemplateOption !== null
    : deviceId !== "" || referenceDeviceId !== "" || equipmentTemplateOption !== null;
  const isDoingExcelUpload = uploadedAirscans.length > 0;
  const validateActive = activeTab === "non-calibration" 
    ? (deviceId !== "" && equipmentTemplateOption !== null) || isDoingExcelUpload
    : (deviceId !== "" && referenceDeviceId !== "" && equipmentTemplateOption !== null) || isDoingExcelUpload;
  const testDisabled =
    Object.keys(checkedAirscanUpload?.unregisteredDeviceIds ?? {}).length === 0;
  const anySuccessful = Object.values(checkedAirscanUpload?.devices ?? {}).some(
    (equipment) => {
      const { lastCommunication, sensors, siteId } = equipment;
      return (
        siteId === 3555 &&
        lastCommunication &&
        sensors
          .map(({ datapoint }) => datapoint.latestDataValue)
          .every((value) => value !== null)
      );
    },
  );
  const registerDisabled =
    Object.values(checkedAirscanUpload?.devices ?? {}).length === 0 ||
    !anySuccessful;

  const listToUpload = isDoingSingleUpload
    ? [
        activeTab === "re-calibration" 
          ? {
              deviceId,
              referenceDeviceId,
              equipmentTemplateName: equipmentTemplate?.publicName,
            } as UploadedAirscan & { referenceDeviceId: string }
          : {
              deviceId,
              equipmentTemplateName: equipmentTemplate?.publicName,
            } as UploadedAirscan,
      ]
    : uploadedAirscans;
  const onValidateClick = async () => {
    try {
      await dispatch(
        checkUploadedAirscansList({ uploadedAirscans: listToUpload }),
      ).unwrap();
      setLastListToUpload(listToUpload);
    } catch (err) {
      toast.error("Invalid device ID(s)");
    }
  };
  const onTestClick = () => {
    if (confirm("Test the unregistered WellStat Air devices?")) {
      dispatch(registerUploadedAirscans({ uploadedAirscans: listToUpload }));
    }
  };
  const onRemoveAirscanClick = ({ deviceId }: { deviceId: string }) => {
    if (confirm("Cancel device test?")) {
      dispatch(
        removeAirscanFromTesting({
          uploadedAirscans: listToUpload,
          deviceId,
        }),
      );
    }
  };
  const onRegisterClick = () => {
    if (
      confirm(
        "Register the test WellStat Air devices? This will allow them to be assigned to existing buildings.",
      )
    ) {
      dispatch(orphanUploadedAirscans({ uploadedAirscans: listToUpload }));
    }
  };

  return (
    <Card className="m-2 mx-5">
      <ConfirmModal
        hideFooter
        isOpen={!!afterCheckMessage}
        onCancel={() => setAfterCheckMessage(undefined)}
        onConfirm={() => setAfterCheckMessage(undefined)}
      >
        {checkedAirscanUpload && <>{afterCheckMessage}</>}
      </ConfirmModal>
      <CardHeader>
        <CardTitle className="w-100">
          <Row className="justify-content-between">
            <Col sm={6}>
              <h2>WellStat Air Testing</h2>
              <h5 style={{ color: "#999" }}>{description}</h5>
            </Col>
            <Col sm={4}>
              <h6 style={{ color: "#999" }} className="text-end">
                This page automatically refreshes every {REFRESH_SECONDS}{" "}
                seconds
              </h6>
            </Col>
          </Row>
        </CardTitle>
      </CardHeader>
      <CardBody>
        {/* Tab Navigation */}
        <Nav tabs>
          <NavItem>
            <NavLink
              className={activeTab === "non-calibration" ? "active" : ""}
              onClick={() => handleTabChange("non-calibration")}
              style={{ cursor: "pointer" }}
            >
              Non-calibration devices
            </NavLink>
          </NavItem>
          <NavItem>
            <NavLink
              className={activeTab === "re-calibration" ? "active" : ""}
              onClick={() => handleTabChange("re-calibration")}
              style={{ cursor: "pointer" }}
            >
              Re-calibration devices
            </NavLink>
          </NavItem>
        </Nav>

        {/* Tab Content */}
        <TabContent activeTab={activeTab}>
          <TabPane tabId="non-calibration">
            {/* Non-calibration tab content */}
            <Card className="mt-3">
              <CardBody style={{ backgroundColor: "#91C8DB", color: "white", textAlign: "center" }}>
                This Page applied to all SKU(s) except SKU1 and SKU 4
              </CardBody>
            </Card>
            
            <Row className="justify-content-end mt-3">
              <Col sm={3}>
                <Row className="align-items-center justify-content-center">
                  <Col sm={6} className="text-end pe-0">
                    Download Template
                  </Col>
                  <Col sm={3}>
                    <a
                      href="https://images.machenergy.com/static/airscan-registration-templates/airscan_registration.xlsx"
                      target="_blank"
                    >
                      <Button
                        outline
                        className="rounded-circle"
                        style={{ padding: "0.8em" }}
                      >
                        <Download cursor="pointer" />
                      </Button>
                    </a>
                  </Col>
                </Row>
              </Col>
            </Row>
            <Row>
              <Col sm={3}>
                <FormGroup>
                  <Label>Device ID</Label>
                  <Input
                    disabled={isDoingExcelUpload}
                    onChange={(e) => setDeviceId(e.target.value)}
                    value={deviceId}
                  />
                </FormGroup>
              </Col>
              <Col sm={3}>
                <FormGroup>
                  <Label>Equipment Type</Label>
                  <Row>
                    <Col sm={showTemplateSensors ? 10 : 12}>
                      <Select
                        isDisabled={isDoingExcelUpload}
                        isClearable
                        value={equipmentTemplateOption}
                        onChange={(e) => setEquipmentTemplateOption(e)}
                        options={Object.values(equipmentTemplates ?? {}).map(
                          (equipmentTemplate) => ({
                            label: equipmentTemplate.publicName,
                            value: equipmentTemplate,
                          }),
                        )}
                        styles={{
                          menu: (base) => ({ ...base, zIndex: 9999 }),
                        }}
                      />
                    </Col>
                    {showTemplateSensors && (
                      <Col
                        sm={2}
                        className="text-center"
                        style={{
                          display: showTemplateSensors ? "block" : "none",
                        }}
                      >
                        <Info id="supported-sensors" cursor={"pointer"} />
                        <UncontrolledPopover
                          placement="right"
                          target="supported-sensors"
                        >
                          <PopoverHeader>Supported Sensors</PopoverHeader>
                          <PopoverBody>
                            <ul>
                              {templateSensors.map(({ id, sensorType }) => (
                                <li key={id}>{sensorType?.name}</li>
                              ))}
                            </ul>
                          </PopoverBody>
                        </UncontrolledPopover>
                      </Col>
                    )}
                  </Row>
                </FormGroup>
              </Col>
              <Col sm={1}>
                <div
                  className="text-center flex-column justify-content-center d-flex"
                  style={{
                    height: "70px",
                    background:
                      "linear-gradient(#ddd, #ddd) no-repeat center/2px 100%",
                  }}
                >
                  <div style={{ background: "white", color: "black" }}>OR</div>
                </div>
              </Col>
              <Col sm={4}>
                <Label>Upload Excel Sheet</Label>
                <InputGroup>
                  <Input
                    innerRef={inputRef}
                    accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                    disabled={isDoingSingleUpload}
                    type="file"
                    onChange={onExcelUpload}
                  />
                  <InputGroupText onClick={onClearInput}>
                    <X />
                  </InputGroupText>
                </InputGroup>
              </Col>
            </Row>
            <Row className="justify-content-end text-end mb-2">
              <Col sm={2}>
                <Button onClick={onValidateClick} disabled={!validateActive}>
                  Validate
                </Button>
              </Col>
              <Col sm={2}>
                <Button
                  color="primary"
                  onClick={onTestClick}
                  disabled={!checkedAirscanUpload || testDisabled}
                >
                  Test Device(s)
                </Button>
              </Col>
              <Col sm={2}>
                <Button
                  color="primary"
                  onClick={onRegisterClick}
                  disabled={!checkedAirscanUpload || registerDisabled}
                >
                  Register Device(s)
                </Button>
              </Col>
            </Row>
          </TabPane>

          <TabPane tabId="re-calibration">
            {/* Re-calibration tab content */}
            <Card className="mt-3">
              <CardBody style={{ backgroundColor: "#91C8DB", color: "white", textAlign: "center" }}>
                This Page applies to SKU 1 and SKU 4 Only
              </CardBody>
            </Card>
            
            <Row className="justify-content-end mt-3">
              <Col sm={3}>
                <Row className="align-items-center justify-content-center">
                  <Col sm={6} className="text-end pe-0">
                    Download Template
                  </Col>
                  <Col sm={3}>
                    <a
                      href="https://images.machenergy.com/static/airscan-registration-templates/airscan_registration_2.xlsx"
                      target="_blank"
                    >
                      <Button
                        outline
                        className="rounded-circle"
                        style={{ padding: "0.8em" }}
                      >
                        <Download cursor="pointer" />
                      </Button>
                    </a>
                  </Col>
                </Row>
              </Col>
            </Row>
            <Row>
              <Col sm={2}>
                <FormGroup>
                  <Label>Device ID</Label>
                  <Input
                    disabled={isDoingExcelUpload}
                    onChange={(e) => setDeviceId(e.target.value)}
                    value={deviceId}
                  />
                </FormGroup>
              </Col>
              <Col sm={2}>
                <FormGroup>
                  <Label>Reference Device ID</Label>
                  <Input
                    disabled={isDoingExcelUpload}
                    onChange={(e) => setReferenceDeviceId(e.target.value)}
                    value={referenceDeviceId}
                  />
                </FormGroup>
              </Col>
              <Col sm={2}>
                <FormGroup>
                  <Label>Equipment Type</Label>
                  <Row>
                    <Col sm={showTemplateSensors ? 10 : 12}>
                      <Select
                        isDisabled={isDoingExcelUpload}
                        isClearable
                        value={equipmentTemplateOption}
                        onChange={(e) => setEquipmentTemplateOption(e)}
                        options={Object.values(equipmentTemplates ?? {}).map(
                          (equipmentTemplate) => ({
                            label: equipmentTemplate.publicName,
                            value: equipmentTemplate,
                          }),
                        )}
                        styles={{
                          menu: (base) => ({ ...base, zIndex: 9999 }),
                        }}
                      />
                    </Col>
                    {showTemplateSensors && (
                      <Col
                        sm={2}
                        className="text-center"
                        style={{
                          display: showTemplateSensors ? "block" : "none",
                        }}
                      >
                        <Info id="supported-sensors-recal" cursor={"pointer"} />
                        <UncontrolledPopover
                          placement="right"
                          target="supported-sensors-recal"
                        >
                          <PopoverHeader>Supported Sensors</PopoverHeader>
                          <PopoverBody>
                            <ul>
                              {templateSensors.map(({ id, sensorType }) => (
                                <li key={id}>{sensorType?.name}</li>
                              ))}
                            </ul>
                          </PopoverBody>
                        </UncontrolledPopover>
                      </Col>
                    )}
                  </Row>
                </FormGroup>
              </Col>
              <Col sm={1}>
                <div
                  className="text-center flex-column justify-content-center d-flex"
                  style={{
                    height: "70px",
                    background:
                      "linear-gradient(#ddd, #ddd) no-repeat center/2px 100%",
                  }}
                >
                  <div style={{ background: "white", color: "black" }}>OR</div>
                </div>
              </Col>
              <Col sm={4}>
                <Label>Upload Excel Sheet</Label>
                <InputGroup>
                  <Input
                    innerRef={inputRef}
                    accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                    disabled={isDoingSingleUpload}
                    type="file"
                    onChange={onExcelUpload}
                  />
                  <InputGroupText onClick={onClearInput}>
                    <X />
                  </InputGroupText>
                </InputGroup>
              </Col>
            </Row>
            <Row className="justify-content-end text-end mb-2">
              <Col sm={2}>
                <Button onClick={onValidateClick} disabled={!validateActive}>
                  Validate
                </Button>
              </Col>
              <Col sm={2}>
                <Button
                  color="primary"
                  onClick={onTestClick}
                  disabled={!checkedAirscanUpload || testDisabled}
                >
                  Test Device(s)
                </Button>
              </Col>
              <Col sm={2}>
                <Button
                  color="primary"
                  onClick={() => {
                    if (confirm("Re-calibrate the devices?")) {
                      // Add re-calibration logic here
                      console.log("Re-calibrating devices...");
                    }
                  }}
                  disabled={!checkedAirscanUpload || testDisabled}
                >
                  Re-Calibrate
                </Button>
              </Col>
              <Col sm={2}>
                <Button
                  color="primary"
                  onClick={onRegisterClick}
                  disabled={!checkedAirscanUpload || registerDisabled}
                >
                  Register Device(s)
                </Button>
              </Col>
            </Row>
          </TabPane>
        </TabContent>

        {/* Existing content that should appear in both tabs */}
        {checkedAirscanUpload && (
          <>
            <Row>
              <AirscanTestingTablePublic
                equipmentTemplates={equipmentTemplates ?? []}
                checkedAirscanUpload={checkedAirscanUpload}
                onRemoveAirscanClick={onRemoveAirscanClick}
              />
            </Row>
            <Row className="justify-content-end text-end m-2">
              <Col sm={4}>
                <Label>Download PDF</Label>
                <DownloadFile
                  file_type="application/pdf"
                  filename="report.pdf"
                  fetchFileData={() =>
                    dispatch(
                      generateManufacturerReport({
                        uploadedAirscans: listToUpload,
                        uuid,
                      }),
                    )
                  }
                />
              </Col>
            </Row>
          </>
        )}
      </CardBody>
    </Card>
  );
};

export default AirscanTestingPagePublic;

https://app.wellstat.io/test-wellstat-air/7af78b40-47a0-428f-ac43-a764081b01a3
https://www.figma.com/proto/QLP9XEvh3ajzi8Z4PzZtfj/WellStat-Redesign?page-id=8944%3A47850&node-id=8944-53516&viewport=-1628%2C2170%2C0.25&t=Ofx8dNEGgfXwDt4X-1&scaling=min-zoom&content-scaling=fixed&starting-point-node-id=8944%3A53516

const validateRecalibrationDevices = async ({
  db,
  uploadedAirscans,
}: {
  db: DBContext;
  uploadedAirscans: UploadedAirscan[];
}): Promise<{
  validSerialNumbers: RecalibrationSerialNumberInfo[];
  invalidSerialNumbers: RecalibrationSerialNumberInfo[];
}> => {
  const validSerialNumbers: RecalibrationSerialNumberInfo[] = [];
  const invalidSerialNumbers: RecalibrationSerialNumberInfo[] = [];
  for (const airscan of uploadedAirscans) {
    const { deviceId, referenceDeviceId, serialNumber, equipmentTemplateName } =
      airscan;
    if (typeof serialNumber === "string" && serialNumber) {
      const calibrationInfo = await findCalibrationByParentSerialNumber(
        db,
        serialNumber,
      );
      if (calibrationInfo && calibrationInfo.length > 0) {
        const { equipment_id, datapoint_id } = calibrationInfo[0];
        if (equipment_id === null && datapoint_id === 0) {
          validSerialNumbers.push({
            deviceId,
            referenceDeviceId,
            serialNumber,
            equipmentTemplateName,
          });
        } else {
          invalidSerialNumbers.push({
            deviceId,
            referenceDeviceId,
            serialNumber,
            equipmentTemplateName,
          });
        }
      } else {
        invalidSerialNumbers.push({
          deviceId,
          referenceDeviceId,
          serialNumber,
          equipmentTemplateName,
        });
      }
    } else {
      invalidSerialNumbers.push({
        deviceId,
        referenceDeviceId,
        serialNumber,
        equipmentTemplateName,
      });
    }
  }
  return { validSerialNumbers, invalidSerialNumbers };
};




